<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞</title>
  <script type="module" src="config.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    /* –í—Å–µ–≥–¥–∞ —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω + —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
    body {
      background-color: #ffffff !important;
      color: #000000 !important;
    }

    /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1e1e1e !important;
        color: #ffffff !important;
      }
      /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ CAPTCHA */
      #captcha-container {
        background: rgba(0, 0, 0, 0.6) !important;
      }
    }

    /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ CAPTCHA */
    #captcha-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
    #animation-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 60vh;
      width: 100%;
    }
    #animation-container {
      width: 55vw;
      max-width: 400px;
      min-width: 220px;
      display: none;
    }
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    .result-container {
      height: 20vh;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80%;
      max-width: 500px;
    }
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    #status {
      font-size: clamp(18px, 4vw, 28px);
      color: inherit !important;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
      width: 100%;
      text-align: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
  </style>
</head>
<body>

  <!-- CAPTCHA -->
  <div id="captcha-container">
    <div class="cf-turnstile" id="captcha" data-callback="unlockSite"></div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ -->
  <div id="animation-wrapper">
    <div id="animation-container"></div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  <div class="result-container">
    <div id="status"></div>
  </div>

  <script type="module">
    import CONFIG from './config.js';

    document.addEventListener("DOMContentLoaded", () => {
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {

        Telegram.WebApp.ready();
        const initDataUnsafe = Telegram.WebApp.initDataUnsafe;
        const telegramId = initDataUnsafe.user.id;

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const urlParams = new URLSearchParams(window.location.search);
        const startAppParam = urlParams.get("startapp") || 
                              urlParams.get("startApp") || 
                              initDataUnsafe.start_param || 
                              null;

        console.log("–¢–µ–∫—É—â–∏–π URL:", window.location.href);
        console.log("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL:", urlParams.get("startapp"), urlParams.get("startApp"));
        console.log("initDataUnsafe.start_param:", initDataUnsafe.start_param);
        console.log("–ò—Ç–æ–≥–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä startAppParam:", startAppParam);

        // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω request_write=1, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
        if (urlParams.get("web_app_request_write_access") === "1") {
          Telegram.WebApp.requestWriteAccess((response) => {
            console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:", response.status);
          });
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Site Key –¥–ª—è CAPTCHA
        document.getElementById("captcha").setAttribute("data-sitekey", CONFIG.SITE_KEY);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º Lottie-–∞–Ω–∏–º–∞—Ü–∏—é
        const animationContainer = document.getElementById("animation-container");
        const anim = lottie.loadAnimation({
          container: animationContainer,
          renderer: "svg",
          loop: true,
          autoplay: false,
          path: "cat.json"
        });

        function unlockSite(token) {
          console.log("CAPTCHA Token:", token);
          document.getElementById("captcha-container").remove();

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
          animationContainer.style.display = "block";
          anim.play();

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±—ç–∫–µ–Ω–¥
          checkAccess(token, startAppParam);
        }

        async function checkAccess(cfToken, startAppParam) {
          if (!telegramId) {
            document.getElementById("status").innerText = "–û—à–∏–±–∫–∞: Telegram ID –Ω–µ –ø–æ–ª—É—á–µ–Ω!";
            document.getElementById("status").style.opacity = "1";
            return;
          }
          
          const user = Telegram.WebApp.initDataUnsafe.user;
          const username = user.username || null;
          const firstName = user.first_name || null;
          const lastName = user.last_name || null;
          const statusElement = document.getElementById("status");
        
          // –ú–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏
          const attemptMessages = [
            "üîç –°–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶",
            "ü§î –°—á–∏—Ç–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤‚Ä¶",
            "üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏‚Ä¶",
            "‚è≥ –ï—â—ë –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞‚Ä¶",
            "üöÄ –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É‚Ä¶"
          ];
        
          const maxAttempts = 5;
          let attempt = 0;
          let response, data;
          let success = false;
          let backoff = 500; // –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 500 –º—Å
        
          while (attempt < maxAttempts && !success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
            statusElement.innerHTML = attemptMessages[attempt];
            statusElement.style.opacity = "1";
            console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${attempt + 1}: ${attemptMessages[attempt]}`);
        
            try {
              response = await fetch(CONFIG.END_POINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ telegramId, cfToken, startAppParam, username, firstName, lastName })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`–û—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}. ${errorText}`);
              }
              
              data = await response.json();
              success = true; // –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
              break;
            } catch (error) {
              console.error(`–ü–æ–ø—ã—Ç–∫–∞ ${attempt + 1} –Ω–µ —É–¥–∞–ª–∞—Å—å:`, error);
              attempt++;
              if (attempt < maxAttempts) {
                // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å –Ω–µ–±–æ–ª—å—à–∏–º –¥–∂–∏—Ç—Ç–µ—Ä–æ–º
                await new Promise(resolve => setTimeout(resolve, backoff + Math.random() * 200));
                backoff *= 2;
              } else {
                // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
                statusElement.innerHTML = "‚è≥ –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.";
                statusElement.style.opacity = "1";
                return;
              }
            }
          }

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω
          if (success && data) {
            if (data.status === "finished") {
              statusElement.innerHTML = "–ö–æ–Ω–∫—É—Ä—Å –∑–∞–≤–µ—Ä—à—ë–Ω üîö";
            } else if (data.status === "allowed") {
              statusElement.innerHTML = "‚úÖ –£—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã";
              Telegram.WebApp.HapticFeedback.impactOccurred("medium");
              confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else if (data.status === "denied") {
              statusElement.innerHTML = "‚ùå –£—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã";
              Telegram.WebApp.HapticFeedback.notificationOccurred("error");
              confetti({
                particleCount: 80,
                spread: 60,
                startVelocity: -40,
                gravity: 1.2,
                origin: { y: -0.2 },
                colors: ['#ff0000', '#ff4444', '#cc0000']
              });
              statusElement.style.animation = "shake 0.3s ease-in-out 2";
            }
            statusElement.style.opacity = "1";
          }
        }

        window.unlockSite = unlockSite;
      } else {
        document.body.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: white;">
            <h1>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–æ—Ç–æ–≤ <a href="https://t.me/bots_space" target="_blank">t.me/bots_space</a></h1>
          </div>
        `;
      }
    });
  </script>

</body>
</html>
